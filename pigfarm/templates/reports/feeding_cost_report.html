{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container my-5">
  <a href="{% url 'dashboard' %}" class="btn btn-primary mb-4">Go to Dashboard</a>
  <h1 class="fw-bold mb-4">Feeding Cost Report</h1>

  <!-- FILTER FORM -->
  <form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-auto">
      <label for="pig_type" class="form-label fw-semibold">Pig Type</label>
      <select name="pig_type" id="pig_type" class="form-select">
        <option value="all" {% if pig_type == 'all' %}selected{% endif %}>All</option>
        <option value="sow" {% if pig_type == 'sow' %}selected{% endif %}>Sow</option>
        <option value="piglet" {% if pig_type == 'piglet' %}selected{% endif %}>Piglet</option>
      </select>
    </div>

    <div class="col-auto">
      <label for="range" class="form-label fw-semibold">Date Range</label>
      <select name="range" id="range" class="form-select">
        <option value="week" {% if range == 'week' %}selected{% endif %}>This Week</option>
        <option value="month" {% if range == 'month' %}selected{% endif %}>This Month</option>
        <option value="custom" {% if range == 'custom' %}selected{% endif %}>Custom</option>
      </select>
    </div>

    <div class="col-auto custom-range-fields" {% if range != 'custom' %}style="display:none;"{% endif %}>
      <label for="start_date" class="form-label fw-semibold">Start Date</label>
      <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
    </div>

    <div class="col-auto custom-range-fields" {% if range != 'custom' %}style="display:none;"{% endif %}>
      <label for="end_date" class="form-label fw-semibold">End Date</label>
      <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
    </div>

    <div class="col-auto">
      <button type="submit" class="btn btn-primary fw-bold px-4">Filter</button>
    </div>

    {% if range or start_date or end_date %}
    <div class="col-auto">
      <a href="{% url 'feeding_cost_report' %}" class="btn btn-light fw-bold">Reset</a>
    </div>
    {% endif %}
  </form>

  {% if start_date and end_date %}
    <p class="text-muted">
      Showing feeding records from
      <strong>{{ start_date|date:"Y-m-d" }}</strong>
      to
      <strong>{{ end_date|date:"Y-m-d" }}</strong>.
    </p>
  {% endif %}

  <div class="table-responsive mt-4">
    <table class="table table-bordered table-hover align-middle shadow-sm rounded">
      <thead class="table-warning text-center">
        <tr>
          <th>Pig Type</th>
          <th>Name</th>
          <th>Animal Tag ID</th>
          <th>Date</th>
          <th>Feed Name</th>
          <th>Quantity</th>
          <th>Total Cost (RWF)</th>
        </tr>
      </thead>
      <tbody>
        {% for rec in records %}
        <tr>
          <td class="fw-bold">{{ rec.pig_type }}</td>
          <td>{{ rec.name }}</td>
          <td class="text-primary">{{ rec.tag|default:"-" }}</td>
          <td class="text-muted">{{ rec.date|date:"Y-m-d" }}</td>
          <td>{{ rec.feed_name }}</td>
          <td class="text-end">{{ rec.quantity|floatformat:2 }}</td>
          <td class="text-end text-success fw-bold">{{ rec.total_cost|floatformat:0|intcomma }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">
            No feeding records found in this period.
          </td>
        </tr>
        {% endfor %}
        {% if records %}
        <tr class="fw-bold table-light">
          <td colspan="6" class="text-end">Total Feeding Cost:</td>
          <td class="text-end text-danger">{{ total_cost|floatformat:0|intcomma }} RWF</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <a href="{% url 'feeding_cost_report_pdf' %}?range={{ range }}&pig_type={{ pig_type }}{% if start_date %}&start_date={{ start_date|date:'Y-m-d' }}{% endif %}{% if end_date %}&end_date={{ end_date|date:'Y-m-d' }}{% endif %}" class="btn btn-danger fw-bold mt-4">
    Download PDF
</a>
</div>

<script>
  document.getElementById('range').addEventListener('change', function () {
    const customFields = document.querySelectorAll('.custom-range-fields');
    if (this.value === 'custom') {
      customFields.forEach(el => el.style.display = 'block');
    } else {
      customFields.forEach(el => el.style.display = 'none');
    }
  });
</script>
{% endblock %}