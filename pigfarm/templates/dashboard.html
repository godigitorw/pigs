{% extends "base.html" %} 
{% load static %} 
{% block title %}Dashboard - Pig
Farm{% endblock %} {% block content %} {% include 'navigation.html' %}
{% load humanize %}

<!--MAIN CONTENT-->
<div class="main-content">
  <!-- HEADER -->
  <div class="header">
    <div class="container-fluid">
      <!-- Body -->
      <div class="header-body">
        <div class="row align-items-end">
          <div class="col">
            <!-- Pretitle -->
            <h6 class="header-pretitle">Overview</h6>

            <!-- Title -->
            <h1 class="header-title">Dashboard</h1>
          </div>
          <div class="col-auto">
            <!-- Button -->
            <!-- Button -->
<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#reportModal">
  Create Report
</button>

<!-- Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="reportModalLabel">Select Report Type</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="list-group">
          <a href="{% url 'finance_report' %}" class="list-group-item list-group-item-action">
            Finance Report
          </a>
          <a href="{% url 'piglet_births_report' %}" class="list-group-item list-group-item-action">
            Piglet Births Report
          </a>
          <a href="{% url 'sow_report' %}" class="list-group-item list-group-item-action">
            Sow Report
          </a>
          <a href="{% url 'weight_report' %}" class="list-group-item list-group-item-action">
            Weight Monitoring Report
          </a>
          <a href="{% url 'feeding_cost_report' %}" class="list-group-item list-group-item-action">
            Feeding Cost Report
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
          </div>
        </div>
        <!-- / .row -->
      </div>
      <!-- / .header-body -->
    </div>
  </div>
  <!-- / .header -->

  <div class="container-fluid">
    <!-- Financial Cards Container -->
    <div class="p-4 rounded-4 mb-4" style="background-color: rgba(9, 118, 18, 0.1);">
      <div class="row">
        <div class="col-12 col-lg-4">
          <!-- Enhanced Profit/Loss Card -->
          <div class="card border border-light-subtle rounded-4 h-100">
            <div class="card-body p-4">
              <!-- Header -->
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                  <h5 class="text-uppercase text-muted fw-semibold mb-0 small">Sales Performance</h5>
                </div>
                <div class="icon icon-shape bg-gradient-primary text-white rounded-circle">
                  <i class="fe fe-trending-up fs-4"></i>
                </div>
              </div>

              <!-- Sales Section -->
              <div class="mb-4">
                <div class="d-flex align-items-center mb-2">
                  <div class="icon icon-sm bg-primary bg-opacity-10 text-primary rounded me-3">
                    <i class="fe fe-dollar-sign"></i>
                  </div>
                  <div class="flex-1">
                    <p class="text-muted small mb-0">Total Sales</p>
                    <h4 class="mb-0 text-primary fw-bold">
                      {{ total_sales|floatformat:0|intcomma }} RWF
                    </h4>
                  </div>
                </div>
              </div>

              <!-- Cost Section -->
              <div class="mb-4">
                <div class="d-flex align-items-center mb-2">
                  <div class="icon icon-sm bg-danger bg-opacity-10 text-danger rounded me-3">
                    <i class="fe fe-minus-circle"></i>
                  </div>
                  <div class="flex-1">
                    <p class="text-muted small mb-0">Total Cost</p>
                    <h4 class="mb-0 text-danger fw-bold">
                      {{ total_spent_on_sold|floatformat:0|intcomma }} RWF
                    </h4>
                  </div>
                </div>
              </div>

              <!-- Divider -->
              <div class="border-top border-2 {% if is_profit %}border-success{% else %}border-danger{% endif %} mx-0 mb-4"></div>

              <!-- Net Profit/Loss -->
              <div class="text-center">
                <p class="text-uppercase text-muted fw-semibold mb-2 small">
                  Net {% if is_profit %}Profit{% else %}Loss{% endif %}
                </p>
                <h2 class="mb-0 {% if is_profit %}text-success{% else %}text-danger{% endif %} fw-bold display-6">
                  {% if is_profit %}+{% else %}-{% endif %}{{ net_profit|floatformat:0|intcomma }} RWF
                </h2>
                <div class="mt-3">
                  <span class="badge {% if is_profit %}bg-success{% else %}bg-danger{% endif %} bg-opacity-15 {% if is_profit %}text-success{% else %}text-danger{% endif %} px-3 py-2">
                    <i class="fe {% if is_profit %}fe-trending-up{% else %}fe-trending-down{% endif %} me-1"></i>
                    {% if is_profit %}Profitable{% else %}Loss Making{% endif %}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <!-- Enhanced Other Income & Expenses Card -->
          <div class="card border border-light-subtle rounded-4 h-100">
            <div class="card-body p-4">
              <!-- Header -->
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                  <h5 class="text-uppercase text-muted fw-semibold mb-0 small">Financial Operations</h5>
                </div>
                <div class="icon icon-shape bg-gradient-info text-white rounded-circle">
                  <i class="fe fe-bar-chart-2 fs-4"></i>
                </div>
              </div>

              <!-- Total Income -->
              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="d-flex align-items-center">
                    <div class="icon icon-sm bg-success bg-opacity-10 text-success rounded me-3">
                      <i class="fe fe-plus-circle"></i>
                    </div>
                    <div>
                      <p class="text-muted small mb-0">Other Income</p>
                      <h4 class="mb-0 text-success fw-bold">
                        {{ total_income|floatformat:0|intcomma }} RWF
                      </h4>
                    </div>
                  </div>
                  <div class="text-end">
                    <span class="badge bg-success bg-opacity-15 text-success">
                      <i class="fe fe-trending-up me-1"></i>Income
                    </span>
                  </div>
                </div>
              </div>

              <!-- Total Expenses -->
              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="d-flex align-items-center">
                    <div class="icon icon-sm bg-danger bg-opacity-10 text-danger rounded me-3">
                      <i class="fe fe-minus-circle"></i>
                    </div>
                    <div>
                      <p class="text-muted small mb-0">Other Expenses</p>
                      <h4 class="mb-0 text-danger fw-bold">
                        {{ total_expense|floatformat:0|intcomma }} RWF
                      </h4>
                    </div>
                  </div>
                  <div class="text-end">
                    <span class="badge bg-danger bg-opacity-15 text-danger">
                      <i class="fe fe-trending-down me-1"></i>Expense
                    </span>
                  </div>
                </div>
              </div>

              <!-- Divider -->
              <div class="border-top border-2 border-info mx-0 mb-4"></div>

              <!-- Net Balance -->
              <div class="text-center">
                <p class="text-uppercase text-muted fw-semibold mb-2 small">Net Operations Balance</p>
                <h3 class="mb-0 {% if balance > 0 %}text-success{% elif balance < 0 %}text-danger{% else %}text-muted{% endif %} fw-bold">
                  {% if balance > 0 %}+{% elif balance < 0 %}-{% endif %}{{ balance|floatformat:0|intcomma }} RWF
                </h3>
                <div class="mt-2">
                  <span class="badge {% if balance > 0 %}bg-success{% elif balance < 0 %}bg-danger{% else %}bg-secondary{% endif %} bg-opacity-15 {% if balance > 0 %}text-success{% elif balance < 0 %}text-danger{% else %}text-muted{% endif %} px-3 py-2">
                    {% if balance > 0 %}
                      <i class="fe fe-check-circle me-1"></i>Positive
                    {% elif balance < 0 %}
                      <i class="fe fe-alert-circle me-1"></i>Negative
                    {% else %}
                      <i class="fe fe-minus me-1"></i>Neutral
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <!-- Enhanced Farm Financial Summary Card -->
          <div class="card border border-light-subtle rounded-4 h-100" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body p-4">
              <!-- Header -->
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                  <h5 class="text-uppercase text-muted fw-semibold mb-2 small">
                    Farm Financial Summary
                  </h5>
                  <div class="d-flex align-items-center">
                    <div class="icon icon-sm {% if is_farm_profitable %}bg-success{% else %}bg-danger{% endif %} bg-opacity-10 {% if is_farm_profitable %}text-success{% else %}text-danger{% endif %} rounded me-2">
                      <i class="fe fe-{% if is_farm_profitable %}trending-up{% else %}trending-down{% endif %}"></i>
                    </div>
                    <span class="badge {% if is_farm_profitable %}bg-success{% else %}bg-danger{% endif %} bg-opacity-15 {% if is_farm_profitable %}text-success{% else %}text-danger{% endif %}">
                      {% if is_farm_profitable %}Profitable Farm{% else %}Operating at Loss{% endif %}
                    </span>
                  </div>
                </div>
                <div class="icon icon-shape {% if is_farm_profitable %}bg-gradient-success{% else %}bg-gradient-danger{% endif %} text-white rounded-circle">
                  <i class="fe fe-{% if is_farm_profitable %}check-circle{% else %}alert-triangle{% endif %} fs-4"></i>
                </div>
              </div>

              <!-- Net Balance -->
              <div class="text-center mb-4">
                <p class="text-muted small mb-1">Overall Net Balance</p>
                <h1 class="display-5 fw-bold {% if is_farm_profitable %}text-success{% else %}text-danger{% endif %} mb-2">
                  {% if is_farm_profitable %}+{% else %}-{% endif %}{{ net_balance|floatformat:0|intcomma }} RWF
                </h1>
                <p class="text-muted small mb-0">
                  <i class="fe fe-info me-1"></i>Total Sales minus All Farm Costs
                </p>
              </div>

              <!-- Divider -->
              <div class="border-top border-2 {% if is_farm_profitable %}border-success{% else %}border-danger{% endif %} mx-0 mb-4"></div>

              <!-- Financial Breakdown -->
              <div class="row g-2">
                <div class="col-6">
                  <div class="text-center p-2 rounded-2" style="background-color: #097612;">
                    <div class="d-flex align-items-center justify-content-center mb-1">
                      <div class="icon icon-xs bg-white bg-opacity-20 text-white rounded me-2">
                        <i class="fe fe-dollar-sign"></i>
                      </div>
                      <small class="text-white mb-0">Revenue</small>
                    </div>
                    <h6 class="fw-bold text-white mb-0 small">
                      {{ total_sales|floatformat:0|intcomma }} RWF
                    </h6>
                  </div>
                </div>
                <div class="col-6">
                  <div class="text-center p-2 rounded-2" style="background-color: #097612;">
                    <div class="d-flex align-items-center justify-content-center mb-1">
                      <div class="icon icon-xs bg-white bg-opacity-20 text-white rounded me-2">
                        <i class="fe fe-credit-card"></i>
                      </div>
                      <small class="text-white mb-0">Total Costs</small>
                    </div>
                    <h6 class="fw-bold text-white mb-0 small">
                      {{ total_farm_cost|floatformat:0|intcomma }} RWF
                    </h6>
                  </div>
                </div>
              </div>

              <!-- Performance Indicator -->
              <div class="mt-4 text-center">
                <div class="progress mb-2" style="height: 8px;">
                  <div class="progress-bar {% if is_farm_profitable %}bg-success{% else %}bg-danger{% endif %}"
                       role="progressbar"
                       style="width: {% if is_farm_profitable %}75{% else %}25{% endif %}%">
                  </div>
                </div>
                <small class="text-muted">
                  <i class="fe fe-{% if is_farm_profitable %}trending-up{% else %}trending-down{% endif %} me-1"></i>
                  Farm Performance: {% if is_farm_profitable %}Excellent{% else %}Needs Improvement{% endif %}
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Total Pigs
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0"> {{ total_pigs }} Pigs </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span class="h2 fe fe-gitlab text-body-secondary mb-0"></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Total Sows
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0"> {{ total_sows }} Sows </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span class="h2 fe fe-gitlab text-body-secondary mb-0"></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Total Piglets
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0"> {{ total_piglets }} piglets </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span class="h2 fe fe-gitlab text-body-secondary mb-0"></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Feed Consumed This Week
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0"> {{ total_feed_consumed }} kg </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span
                  class="h2 fe fe-git-commit text-body-secondary mb-0"
                ></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Feed Cost This Week
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0"> {{ total_feed_cost }} RWF </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span
                  class="h2 fe fe-git-commit text-body-secondary mb-0"
                ></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Health Cost
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0">
                  {{ total_health_cost|floatformat:0|intcomma }} RWF
                </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span
                  class="h2 fe fe-git-commit text-body-secondary mb-0"
                ></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Vacination Cost
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0">
                  {{ total_vaccination_cost|floatformat:0|intcomma }} RWF
                </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span
                  class="h2 fe fe-git-commit text-body-secondary mb-0"
                ></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <!-- Hours -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center gx-0">
              <div class="col">
                <!-- Title -->
                <h6 class="text-uppercase text-body-secondary mb-2">
                  Breeding Cost
                </h6>

                <!-- Heading -->
                <span class="h2 mb-0">
                  {{ total_breeding_cost|floatformat:0|intcomma }} RWF
                </span>
              </div>
              <div class="col-auto">
                <!-- Icon -->
                <span
                  class="h2 fe fe-git-commit text-body-secondary mb-0"
                ></span>
              </div>
            </div>
            <!-- / .row -->
          </div>
        </div>
      </div>

      <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="text-uppercase text-muted">Total Farm Cost</h6>
              <i class="fe fe-dollar-sign fs-3 text-warning"></i>
            </div>
            <h3 class="mb-0 text-dark fw-bold">
              {{ total_farm_cost|floatformat:0|intcomma }} RWF
            </h3>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body p-3">
            <h6 class="text-uppercase text-muted fw-bold mb-3">Feed Stock</h6>
            <div
              class="table-responsive"
              style="max-height: 250px; overflow-y: auto"
            >
              <table class="table table-sm table-borderless mb-0">
                <thead>
                  <tr class="text-muted small">
                    <th>Feed</th>
                    <th class="text-end">Qty</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for feed in feed_stocks %}
                  <tr>
                    <td>{{ feed.name }}</td>
                    <td class="text-end">
                      {{ feed.stock_quantity }} {{ feed.unit }}
                    </td>
                    <td>
                      <span
                        class="badge bg-{{ feed.stock_status_class }} bg-opacity-75"
                      >
                        {{ feed.stock_status }}
                      </span>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="3" class="text-center text-muted small">
                      No feed available
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card mt-4">
          <div class="card-header bg-warning text-white">
            <h5 class="mb-0">Ongoing Health Treatments</h5>
          </div>
          <div class="card-body">
            {% if ongoing_health_records %}
            <ul class="list-group">
              {% for record in ongoing_health_records %}
              <li
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  {% if record.sow %}
                  <strong>Sow:</strong> {{ record.sow.name }} {% elif
                  record.piglet %} <strong>Piglet:</strong> {{
                  record.piglet.name }} {% endif %}
                </div>
                <span class="badge bg-warning text-dark">Ongoing</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No ongoing treatments.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card mt-4">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">Pigs Due for Vaccination in Less Than 1 Month</h5>
          </div>
          <div class="card-body">
            {% if upcoming_vaccinations %}
            <ul class="list-group">
              {% for record in upcoming_vaccinations %}
              <li
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  {% if record.sow %}
                  <strong>Sow:</strong> {{ record.sow.name }} {% elif
                  record.piglet %} <strong>Piglet:</strong> {{
                  record.piglet.name }} {% endif %}
                  <br />
                  <small
                    ><strong>Vaccine:</strong> {{ record.vaccine.name }}</small
                  ><br />
                  <small
                    ><strong>Next Due:</strong> {{ record.next_vaccination_date
                    }}</small
                  >
                </div>
                <span class="badge bg-danger">Due Soon</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">
              No upcoming vaccinations in the next month.
            </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('customFeedChart').getContext('2d');

    // Destroy if already created
    if (window.customFeedChartInstance) {
      window.customFeedChartInstance.destroy();
    }

    // Initialize custom chart
    window.customFeedChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ cost_chart_labels|safe }},
        datasets: [
          {
            label: 'Kg Consumed',
            data: {{ quantity_chart_values|safe }},
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true,
            tension: 0.4,
            pointRadius: 4
          },
          {
            label: 'Feed Cost (RWF)',
            data: {{ cost_chart_values|safe }},
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Kg / RWF' }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const unit = context.dataset.label.includes('Cost') ? 'RWF' : 'kg';
                return context.dataset.label + ': ' + context.parsed.y + ' ' + unit;
              }
            }
          }
        }
      }
    });
  </script>
  {% endblock %} {% endblock %}
</div>
